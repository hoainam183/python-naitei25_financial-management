{% load i18n %}
{% load custom_bill_status %}

<form method="get" class="mb-6 bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg flex items-end space-x-4">
    <div>
        <label for="month-ew" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
            {% trans "Chọn tháng để xem/nhập liệu" %}
        </label>
        <input id="month-ew" type="text" name="month" value="{{ selected_month|date:'Y-m-d' }}" placeholder="Chọn tháng..." class="border rounded p-2 mt-1 month-picker">
    </div>
    <button type="submit" class="bg-indigo-600 text-white h-11 px-6 rounded-lg hover:bg-indigo-700 font-semibold">
        {% trans "Xem Dữ Liệu" %}
    </button>
</form>

{% if selected_month %}
    <div class="mb-6 p-4 rounded-lg {% if building_total %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
        {% if building_total %}
            <h3 class="font-bold">{% trans "Đã nhập tổng cho tháng" %} {{ selected_month|date:"m/Y" }}: {% trans "Tổng điện" %} {{ building_total.total_electricity }} kWh | {% trans "Tổng nước" %} {{ building_total.total_water }} m³</h3>
        {% else %}
            <h3 class="font-bold">{% trans "CHƯA NHẬP TỔNG CHO THÁNG" %} {{ selected_month|date:"m/Y" }}!</h3>
            <p>{% trans "Vui lòng" %} <a href="{% url 'utility_totals' %}" target="_blank" class="underline font-semibold">{% trans "vào đây" %}</a> {% trans "để nhập trước khi ghi chỉ số cho các phòng." %}</p>
        {% endif %}
    </div>

    {% if building_total %}
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg shadow">
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for data in rooms_data %}
                <tr>
                    <td class="p-3 font-medium">{{ data.room.description }}</td>
                    <td class="p-3 text-sm">Đ: {{ data.prev_reading_index }} | N: {{ data.prev_reading_water_index }}</td>
                    <td class="p-3">
                        {% if data.draft and data.draft.status == 'CONFIRMED' %}
                            <span class="text-gray-500 italic">{% trans "Cư dân đã xác nhận." %}</span>
                        {% else %}
                            <form action="{% url 'save_meter_reading' data.room.pk %}" method="post" class="flex items-center space-x-2">
                                {% csrf_token %}
                                <input type="hidden" name="month" value="{{ selected_month|date:'Y-m-d' }}">
                                <input type="number" step="1" name="electricity_index" placeholder="Số điện mới" class="border p-2 w-32 rounded-md" {% if data.reading %}value="{{ data.reading.electricity_index }}"{% endif %} required>
                                <input type="number" step="1" name="water_index" placeholder="Số nước mới" class="border p-2 w-32 rounded-md" {% if data.reading %}value="{{ data.reading.water_index }}"{% endif %} required>
                                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">{% trans "Lưu" %}</button>
                            </form>
                        {% endif %}
                    </td>
                    <td class="p-3">
                        {% if data.draft %}<a href="{% url 'draft_bill_detail' data.draft.pk %}" class="font-semibold text-blue-600 hover:underline">{% display_draft_bill_status data.draft %}</a>{% else %}<span class="text-gray-500">{% trans "Chưa tạo" %}</span>{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

{% else %}
    <p class="text-center text-gray-600 dark:text-gray-400 mt-8">{% trans "Vui lòng chọn một tháng để bắt đầu làm việc." %}</p>
{% endif %}
