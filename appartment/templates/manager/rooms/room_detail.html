{% extends "base_manager.html" %}
{% load i18n %}
{% load static %}
{% block content %}
{% load custom_filters %}

<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-door-open mr-3 text-blue-600"></i>
                    {% blocktrans with room_id=room.room_id %}Phòng {{ room_id }}{% endblocktrans %}
                </h1>
                <p class="text-gray-600 pl-2">{% trans "Chi tiết thông tin và danh sách cư dân" %}</p>
            </div>
            <div class="flex space-x-3">
                <a href="{% url 'room_update' room.room_id %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5 mr-2" fill="currentColor">
                    <path d="M362.7 19.31c24.96-24.96 65.47-24.96 90.42 0l39.56 39.56c24.96 24.96 24.96 65.47 0 90.42l-43 43L319.7 62.31l43-43zM295.8 86.18L25.34 356.7 0 512l155.3-25.34 270.5-270.5-129.9-129.9z"/>
                    </svg>
                    {% trans "Chỉnh sửa" %}
                </a>
                <a href="{% url 'room_list' %}" class="inline-flex items-center px-4 py-2 text-gray-600 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" 
                        viewBox="0 0 448 512" 
                        class="w-5 h-5 mr-2"
                        fill="currentColor">
                    <path d="M257.5 445.1c12.5-12.5 12.5-32.8 0-45.3L147.3 288H424c17.7
                    0 32-14.3 32-32s-14.3-32-32-32H147.3L257.5 112.1c12.5-12.5
                    12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160c-12.5
                    12.5-12.5 32.8 0 45.3l160 160c12.5
                    12.5 32.8 12.5 45.3 0z"/>
                    </svg>
                    {% trans "Quay lại" %}
                </a>
                <a href="{% url 'room_history' room.room_id %}" 
                    class="relative group inline-flex items-center justify-center px-4 py-2 text-gray-600 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" 
                        viewBox="0 0 640 640"
                        class="w-5 h-5 pointer-events-none"
                        fill="currentColor">
                        <path d="M320 128C426 128 512 214 512 320C512 426 426 512 320 512C254.8 512 197.1 479.5 162.4 429.7C152.3 415.2 132.3 411.7 117.8 421.8C103.3 431.9 99.8 451.9 109.9 466.4C156.1 532.6 233 576 320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C234.3 64 158.5 106.1 112 170.7L112 144C112 126.3 97.7 112 80 112C62.3 112 48 126.3 48 144L48 256C48 273.7 62.3 288 80 288L104.6 288C105.1 288 105.6 288 106.1 288L192.1 288C209.8 288 224.1 273.7 224.1 256C224.1 238.3 209.8 224 192.1 224L153.8 224C186.9 166.6 249 128 320 128zM344 216C344 202.7 333.3 192 320 192C306.7 192 296 202.7 296 216L296 320C296 326.4 298.5 332.5 303 337L375 409C384.4 418.4 399.6 418.4 408.9 409C418.2 399.6 418.3 384.4 408.9 375.1L343.9 310.1L343.9 216z"/>
                    </svg>
                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 text-xs text-white bg-gray-800 rounded opacity-0 group-hover:opacity-100 transition duration-200 whitespace-nowrap z-50">
                        {% trans "Lịch sử phòng"%}
                    </span>
                </a>
            </div>
        </div>
        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="mb-6 p-4 rounded-lg {% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800{% elif message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}">
                    <div class="flex items-center">
                        {% if message.tags == 'success' %}
                            <i class="fas fa-check-circle mr-2"></i>
                        {% elif message.tags == 'error' %}
                            <i class="fas fa-exclamation-circle mr-2"></i>
                        {% else %}
                            <i class="fas fa-info-circle mr-2"></i>
                        {% endif %}
                        {{ message }}
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Room Information -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">
                        <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                        {% trans "Thông tin phòng" %}
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Status -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">{% trans "Trạng thái:" %}</span>
                            <span class="px-3 py-1 text-sm font-medium rounded-full
                                {% if room.status == 'available' %}bg-green-100 text-green-800
                                {% elif room.status == 'occupied' %}bg-red-100 text-red-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ room.get_status_display }}
                            </span>
                        </div>

                        <!-- Area -->
                        {% if room.area %}
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">{% trans "Diện tích:" %}</span>
                            <span class="font-medium">{{ room.area }} m²</span>
                        </div>
                        {% endif %}

                        <!-- Max Occupants -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">{% trans "Số người tối đa:" %}</span>
                            <span class="font-medium">{{ room.max_occupants }} {% trans "người" %}</span>
                        </div>

                        <!-- Current Occupants -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">{% trans "Đang ở hiện tại:" %}</span>
                            <span class="font-medium text-blue-600">{{ current_occupants_count }} {% trans "người" %}</span>
                        </div>

                        <!-- Available Spots -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">{% trans "Chỗ trống:" %}</span>
                            <span class="font-medium {% if available_spots > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                {{ available_spots }} {% trans "chỗ" %}
                            </span>
                        </div>

                        <!-- Occupancy Rate -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">{% trans "Tỷ lệ lấp đầy:" %}</span>
                            <span class="font-medium">{{ occupancy_rate }}%</span>
                        </div>

                        <!-- Created Date -->
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">{% trans "Ngày tạo:" %}</span>
                            <span class="font-medium">{{ room.created_at|format_date_dmy }}</span>
                        </div>
                    </div>

                    <!-- Occupancy Progress Bar -->
                    <div class="mt-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>{% trans "Tỷ lệ lấp đầy" %}</span>
                            <span>{{ current_occupants_count }}/{{ room.max_occupants }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="occupancy-progress" class="h-2 rounded-full {% if occupancy_rate < 50 %}bg-green-500{% elif occupancy_rate < 80 %}bg-yellow-500{% else %}bg-red-500{% endif %}" 
                                 data-width="{{ occupancy_rate }}"></div>
                        </div>
                    </div>

                    <!-- Description -->
                    {% if room.description %}
                    <div class="mt-6">
                        <h3 class="text-sm font-medium text-gray-900 mb-2">{% trans "Mô tả:" %}</h3>
                        <p class="text-gray-700 bg-gray-50 p-3 rounded-md">{{ room.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Current Residents -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">
                        <i class="fas fa-users mr-2 text-green-600"></i>
                        {% blocktrans %}Người đang ở hiện tại ({{ current_occupants_count }}){% endblocktrans %}
                    </h2>
                    
                    {% if current_residents %}
                        <div class="space-y-3">
                            {% for resident in current_residents %}
                                <div class="flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-medium">
                                            {{ resident.user.full_name|first|upper }}
                                        </div>
                                        <div class="ml-3">
                                            <p class="font-medium text-gray-900">{{ resident.user.full_name }}</p>
                                            <p class="text-sm text-gray-600">{{ resident.user.email }}</p>
                                            {% if resident.user.phone %}
                                                <p class="text-sm text-gray-600">{{ resident.user.phone }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-medium text-gray-900">{% trans "Vào ở:" %}</p>
                                        <p class="text-sm text-gray-600">{{ resident.move_in_date|date:"d/m/Y H:i" }}</p>
                                        <p class="text-xs text-green-600 mt-1">
                                            <i class="fas fa-check-circle mr-1"></i>{% trans "Đang ở" %}
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-user-slash text-gray-300 text-4xl mb-3"></i>
                            <p class="text-gray-500">{% trans "Hiện tại chưa có ai ở trong phòng này" %}</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Past Residents History -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">
                        <i class="fas fa-history mr-2 text-gray-600"></i>
                        {% trans "Lịch sử cư dân" %}
                    </h2>
                    
                    {% if past_residents %}
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            {% for resident in past_residents %}
                                <div class="flex items-center justify-between p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-gray-400 rounded-full flex items-center justify-center text-white font-medium">
                                            {{ resident.user.full_name|first|upper }}
                                        </div>
                                        <div class="ml-3">
                                            <p class="font-medium text-gray-900">{{ resident.user.full_name }}</p>
                                            <p class="text-sm text-gray-600">{{ resident.user.email }}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-600">
                                            {{ resident.move_in_date|format_date_dmy }} - {{ resident.move_out_date|format_date_dmy }}
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">
                                            <i class="fas fa-sign-out-alt mr-1"></i>{% trans "Đã rời đi" %}
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-history text-gray-300 text-4xl mb-3"></i>
                            <p class="text-gray-500">{% trans "Chưa có lịch sử cư dân nào" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <div class="text-2xl font-bold text-blue-600">{{ current_occupants_count }}</div>
                <div class="text-sm text-gray-600">{% trans "Đang ở hiện tại" %}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <div class="text-2xl font-bold text-green-600">{{ available_spots }}</div>
                <div class="text-sm text-gray-600">{% trans "Chỗ trống" %}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <div class="text-2xl font-bold text-purple-600">{{ total_residents_ever }}</div>
                <div class="text-sm text-gray-600">{% trans "Tổng cư dân" %}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <div class="text-2xl font-bold text-orange-600">{{ occupancy_rate }}%</div>
                <div class="text-sm text-gray-600">{% trans "Tỷ lệ lấp đầy" %}</div>
            </div>
        </div>
    </div>
    <script src="{% static 'js/room_detail.js' %}"></script>
</body>
{% endblock %}